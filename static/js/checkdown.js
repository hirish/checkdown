// Generated by CoffeeScript 1.6.3
var Debt, Debts, MyButtons, MyChargeButtons, MyDebt, MyList, MyPaymentButtons, MyUser, RecentDebt, RecentList, User, Users;

User = Backbone.Model.extend({
  initialize: function(o) {
    this.set('username', o.username);
    this.set('email', o.email);
    return this.set('id', o.id);
  },
  defaults: {
    username: 'None',
    email: 'None'
  },
  toString: function() {
    return "[User: " + this.get('username') + "]";
  }
});

Debt = Backbone.Model.extend({
  initialize: function(o, options) {
    var debtor, lender, users;
    users = options.users;
    lender = users.get(o.lender.id);
    debtor = users.get(o.debtor.id);
    this.set('id', o.id);
    this.set('lender', lender);
    this.set('debtor', debtor);
    this.set('amount', o.amount);
    this.set('created', o.created);
    if (o.paid != null) {
      this.set('paid', o.paid);
    }
    if (o.description != null) {
      return this.set('description', o.description);
    }
  },
  defaults: {
    debtor: null,
    lender: null,
    description: 'None',
    created: null,
    paid: false
  },
  toString: function() {
    if (this.get('paid')) {
      return "[Debt: " + this.get('debtor') + " owed " + this.get('lender') + " " + this.get('amount') + "]";
    } else {
      return "[Debt: " + this.get('debtor') + " owes " + this.get('lender') + " " + this.get('amount') + "]";
    }
  }
});

Users = Backbone.Collection.extend({
  url: "users",
  model: User
});

Debts = Backbone.Collection.extend({
  url: "debts",
  model: Debt,
  lenderIs: function(user) {
    return new Debts(this.filter(function(debt) {
      return debt.get('lender').id === user.id;
    }));
  },
  debtorIs: function(user) {
    return new Debts(this.filter(function(debt) {
      return debt.get('debtor').id === user.id;
    }));
  },
  groupByDebtor: function() {
    var debtor, grouped;
    grouped = this.groupBy(function(debt) {
      return debt.get('debtor').get('username');
    });
    for (debtor in grouped) {
      grouped[debtor] = new Debts(grouped[debtor]);
    }
    return grouped;
  },
  groupByLender: function() {
    var grouped, lender;
    grouped = this.groupBy(function(debt) {
      return debt.get('lender').get('username');
    });
    for (lender in grouped) {
      grouped[lender] = new Debts(grouped[lender]);
    }
    return grouped;
  },
  totalAmount: function() {
    return this.reduce((function(x, y) {
      return x + y.get('amount');
    }), 0);
  }
});

/* Views: Recent Debts
*/


RecentList = React.createClass({
  getInitialState: function() {
    var _this = this;
    this.props.debts.on('change add remove', function(e) {
      return _this.setState({
        debts: _this.props.debts
      });
    });
    return {
      debts: this.props.debts
    };
  },
  render: function() {
    var renderedDebts;
    renderedDebts = this.state.debts.map(function(debt) {
      return RecentDebt({
        debt: debt
      });
    });
    return React.DOM.div({
      id: "debtview"
    }, renderedDebts);
  }
});

RecentDebt = React.createClass({
  render: function() {
    var a, amount, debtor, description, div, i, lender, span, _ref;
    debtor = this.props.debt.get('debtor').get('username');
    lender = this.props.debt.get('lender').get('username');
    amount = this.props.debt.get('amount');
    description = this.props.debt.get('description');
    _ref = React.DOM, div = _ref.div, a = _ref.a, i = _ref.i, span = _ref.span;
    return div({
      className: "debt"
    }, div({
      className: "heading"
    }, a({}, debtor), i({
      className: "fa fa-arrow-circle-right"
    }), a({}, lender), span({
      className: "amount"
    }, "$" + amount)), div({
      className: "description"
    }, description));
  }
});

/* Views: My coalesced debts and loans
*/


MyList = React.createClass({
  getInitialState: function() {
    var _this = this;
    this.props.debts.on('change add remove', function(e) {
      return _this.setState({
        debts: _this.props.debts,
        users: _this.props.users,
        user: _this.props.users.get(_this.props.userId)
      });
    });
    return {
      user: this.props.users.get(this.props.userId),
      debts: this.props.debts,
      users: this.props.users
    };
  },
  render: function() {
    var renderedUsers,
      _this = this;
    renderedUsers = this.state.users.map(function(otherUser) {
      var debts, loans;
      debts = _this.props.debts.debtorIs(_this.state.user).lenderIs(otherUser);
      loans = _this.props.debts.lenderIs(_this.state.user).debtorIs(otherUser);
      if (debts.length > 0 || loans.length > 0) {
        return MyUser({
          user: _this.state.user,
          username: otherUser.get('username'),
          debts: debts,
          loans: loans
        });
      } else {

      }
    });
    return React.DOM.div({}, renderedUsers);
  }
});

MyUser = React.createClass({
  render: function() {
    var a, debts, div, loans, renderedAmount, renderedDebts, renderedLoans, startText, topText, total, ul, _ref;
    _ref = React.DOM, div = _ref.div, a = _ref.a, ul = _ref.ul;
    total = this.props.debts.totalAmount() - this.props.loans.totalAmount();
    if (total > 0) {
      startText = "You owe ";
      renderedAmount = " a total of $" + total + ". ";
    } else if (total < 0) {
      startText = "You are owed by ";
      renderedAmount = " a total of $" + Math.abs(total) + ". ";
    }
    topText = [
      startText, a({
        style: {
          'font-weight': 'bold'
        }
      }, this.props.username), renderedAmount
    ];
    if (this.props.debts.length > 0) {
      renderedDebts = this.props.debts.map(function(debt) {
        return MyDebt({
          debt: debt,
          isDebt: true
        });
      });
      debts = [
        "You owe ", a({
          style: {
            'font-weight': 'bold'
          }
        }, this.props.username), " for:", ul({
          className: "fa-ul debt-details"
        }, renderedDebts)
      ];
    } else {
      debts = [];
    }
    if (this.props.loans.length > 0) {
      renderedLoans = this.props.loans.map(function(debt) {
        return MyDebt({
          debt: debt,
          isDebt: false
        });
      });
      loans = [
        a({
          style: {
            'font-weight': 'bold'
          }
        }, this.props.username), " owes you for:", ul({
          className: "fa-ul debt-details"
        }, renderedLoans)
      ];
    } else {
      loans = [];
    }
    return div({
      className: "person-debt"
    }, topText, debts, loans, MyButtons({
      total: total
    }));
  }
});

MyDebt = React.createClass({
  render: function() {
    var amount, color, date, description, i, li, span, _ref;
    date = "08-22-2012";
    description = this.props.debt.get('description');
    amount = this.props.debt.get('amount');
    if (this.props.isDebt) {
      color = 'alert';
    } else {
      color = 'success';
    }
    _ref = React.DOM, li = _ref.li, i = _ref.i, span = _ref.span;
    return li({}, i({
      className: "fa-li fa fa-arrow-circle-right"
    }), span({
      className: 'date'
    }, date + ': '), span({
      className: 'description'
    }, description), span({
      className: 'label right radius ' + color
    }, '$' + amount));
  }
});

MyButtons = React.createClass({
  render: function() {
    var buttons, total;
    total = this.props.total;
    if (total > 0) {
      buttons = MyPaymentButtons({
        total: total
      });
    } else if (total < 0) {
      buttons = MyChargeButtons({
        total: total
      });
    }
    return React.DOM.div({
      className: "text-center",
      style: {
        width: "100%"
      }
    }, buttons);
  }
});

MyPaymentButtons = React.createClass({
  render: function() {
    var total;
    total = this.props.total;
    return React.DOM.div({}, React.DOM.button({
      className: "button tiny radius"
    }, "Pay $" + total), " ", React.DOM.button({
      className: "button tiny radius success"
    }, "Pay Other"));
  }
});

MyChargeButtons = React.createClass({
  render: function() {
    var total;
    total = Math.abs(this.props.total);
    return React.DOM.div({}, React.DOM.button({
      className: "button tiny radius"
    }, "Charge $" + total));
  }
});

$(function() {
  var debts, userId, users;
  window.users = users = new Users();
  users.fetch();
  window.debts = debts = new Debts();
  debts.fetch({
    users: users
  });
  userId = 2;
  React.renderComponent(RecentList({
    debts: debts
  }), $('#debtviewholder')[0]);
  return React.renderComponent(MyList({
    userId: userId,
    debts: debts,
    users: users
  }), $('#owe')[0]);
});
